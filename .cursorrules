# N8N Ops - AI Assistant Rules

## Testing Requirements (MANDATORY)

**IMPORTANT: Always test changes before telling the user to test them.**

Before reporting that a change is complete or asking the user to test:

1. **Backend changes**: Run `pytest` or relevant test file to verify no regressions
2. **Frontend changes**: Run `npm run build` to catch TypeScript/compilation errors
3. **API changes**: Use `curl` or test the endpoint directly to verify it works
4. **Full-stack changes**: Verify both backend and frontend compile/pass tests

If tests fail, fix the issues before reporting completion. Do not hand off broken code to the user.

## Server and Port Rules (MANDATORY)

**NEVER start, stop, or restart servers:**
- Cursor does NOT manage starting, stopping, or restarting the frontend or backend
- Do NOT attempt to start, stop, or restart servers
- Do NOT force-kill processes or manage ports
- Do NOT use port enforcement scripts or reload functionality

**When servers need to be started/stopped/restarted:**
- **ALWAYS tell the user in SIMPLE, ALL-CAPS terms**
- Use clear, prominent formatting to make it impossible to miss
- Examples:
  ```
  ════════════════════════════════════════════════════════════
  ⚠️  ACTION REQUIRED: START BACKEND SERVER
  ════════════════════════════════════════════════════════════
  
  The backend server is not running. Please start it:
  
  cd app-back
  python scripts/start_with_migrations.py
  ```
  
  ```
  ════════════════════════════════════════════════════════════
  ⚠️  ACTION REQUIRED: RESTART BACKEND SERVER
  ════════════════════════════════════════════════════════════
  
  This change requires a backend restart. Please restart the backend server.
  ```
  
  ```
  ════════════════════════════════════════════════════════════
  ⚠️  ACTION REQUIRED: START FRONTEND SERVER
  ════════════════════════════════════════════════════════════
  
  The frontend server is not running. Please start it:
  
  cd app-front
  npm run dev
  ```

- **Use these exact phrases when appropriate:**
  - `⚠️  ACTION REQUIRED: START BACKEND SERVER`
  - `⚠️  ACTION REQUIRED: START FRONTEND SERVER`
  - `⚠️  ACTION REQUIRED: RESTART BACKEND SERVER`
  - `⚠️  ACTION REQUIRED: RESTART FRONTEND SERVER`
  - `⚠️  ACTION REQUIRED: STOP BACKEND SERVER`
  - `⚠️  ACTION REQUIRED: STOP FRONTEND SERVER`

- Explain why the action is needed (e.g., "This change requires a backend restart to take effect.")
- Do not attempt to start/stop/restart servers yourself

**NEVER change ports without permission:**
- Port configuration in `.env.local` is sacred - **NEVER modify without asking**
- Do not change `VITE_API_BASE_URL`, `BACKEND_PORT`, `FRONTEND_PORT`, or any port settings
- If you believe a port change is needed, explain why and get explicit approval first

## Database Migrations

**CRITICAL**: When you make ANY database schema change, you MUST:

1. **Create an Alembic migration file** using the helper script:
   ```bash
   python app-back/scripts/create_migration.py "descriptive_name" --sql "YOUR_SQL_HERE"
   ```

2. The migration must include:
   - `upgrade()` function with the SQL (use `op.execute()` for raw SQL)
   - `downgrade()` function (can be `pass` if not reversible, or include reverse SQL)

3. **Add a code comment** where the schema is documented or referenced:
   ```python
   # Migration: <revision_id> - <description>
   # See: alembic/versions/XXXXX_<description>.py
   ```

4. **Inform the user**:
   - "Created migration: <filename>"
   - "Run: alembic upgrade head"

**Schema change triggers:**
- CREATE TABLE
- ALTER TABLE (ADD/DROP/MODIFY COLUMN)
- CREATE/DROP INDEX
- CREATE/DROP FUNCTION/TRIGGER
- CREATE/DROP VIEW
- Any SQL in code comments, documentation, or user requests
- Any mention of "add column", "create table", "schema change", etc.

**Migration naming convention:**
- Use descriptive, lowercase names with underscores
- Examples: "add_last_login_to_users", "create_audit_logs_table", "add_provider_column_to_environments"
- Timestamp is auto-generated by Alembic

**SQL best practices:**
- Use idempotent SQL when possible (IF NOT EXISTS, IF EXISTS)
- Always include both upgrade and downgrade functions
- Test migrations before committing

**Example workflow:**
User: "Add a provider column to environments table"
You should:
1. Create migration: `python app-back/scripts/create_migration.py "add_provider_to_environments" --sql "ALTER TABLE environments ADD COLUMN IF NOT EXISTS provider TEXT NOT NULL DEFAULT 'n8n';"`
2. Add comment in relevant code file: `# Migration: <revision_id> - Added provider column to environments`
3. Tell user: "Created migration. Run: alembic upgrade head"

## Code Style

- Follow existing patterns in the codebase
- Keep functions under 200-300 lines (refactor if needed)
- Avoid code duplication - check for existing similar functionality
- No comments unless necessary (API keys, etc.)
- Simple solutions preferred over complex ones

## Testing

- When adding new features, consider if tests are needed
- Use existing test patterns from the `tests/` directory
- Mock external API calls (n8n, GitHub, etc.)

## Project Structure

- Backend: `app-back/`
- Frontend: `app-front/`
- Database migrations: `app-back/alembic/versions/`
- Scripts: `app-back/scripts/`

